---
title: "sparkvis"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**sparkvis** adds the necessary methods to **ggvis** to allow it to handle **sparklyr's** *tbl_spark* class data sets.  

Currently implemented **layers**:

- layer_bars

- layer_boxplots

- layer_histograms

To do:

- Add support to Fill prop, especially for layer_bars


### Installation

You can install **sparkvis** from GitHub

```{r, eval = FALSE}
devtools::install_github("edgararuiz/sparkvis")
```

### Load needed libraries


```{r, eval = FALSE}
library(sparklyr)
library(ggvis)
library(sparkvis)
library(nycflights13)
```

```{r, include = FALSE, eval = TRUE}
library(sparklyr)
library(ggvis)
library(sparkvis)
library(nycflights13)
```

### Create a new Spark connection

```{r}
conf <- spark_config()
conf$`sparklyr.shell.driver-memory` <- "8G"
sc <- spark_connect(master="local", config = conf, version = "2.1.0")
```

### Copying 'flights' to the Spark environment


```{r}
spark_flights <- copy_to(sc, flights)
```


## Bar chart

### Discrete X 

```{r}
spark_flights %>% 
  ggvis(~carrier) %>% 
  layer_bars()
```

### Convert Continuos X into Discrete (a.k.a w/o using as.factor)

```{r}
spark_flights %>% 
  dplyr::mutate(hour = as.character(hour)) %>%
  ggvis(~hour) %>% 
  layer_bars()
```

### Discrete X with a Weight variable

```{r}
spark_flights %>% 
  ggvis(~carrier, ~distance) %>%
  layer_bars(stack = FALSE)
```



## Box Plot

**Outliers** are not implemented in this initial version.  Need to find a more appropriate way to display them when working with Big Data.


### Carrier over Distance

```{r}
flights %>% 
  ggvis(~carrier,  ~distance) %>% 
  layer_boxplots()

spark_flights %>% 
  ggvis(~carrier,  ~distance) %>% 
  layer_boxplots()


```

#### Raw Table Comparison

** Data Frame**

```{r}

flights %>% 
  group_by(carrier) %>%
  compute_boxplot(~distance)
```

** Spark Table**

```{r}



spark_flights %>% 
  group_by(carrier) %>%
  compute_boxplot(~distance)


```

### Carrier over Arrivel Delay

```{r}
spark_flights %>% 
  ggvis(~carrier,  ~dep_time) %>% 
  layer_boxplots()

```



## Histogram


```{r}
spark_flights %>% 
  dplyr::filter(distance > 0) %>%
  ggvis(~distance) %>% 
  layer_histograms( stack = FALSE, width = 300) 
```

```{r}
spark_flights %>% 
  dplyr::filter(arr_delay < 200) %>%
  ggvis(~arr_delay) %>% 
  layer_histograms( stack = FALSE, width = 20) 
```



### Closing connection

```{r}
spark_disconnect(sc)
```
